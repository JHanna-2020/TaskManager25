{% extends "base.html" %}

{% block title %}Completed Tasks - Task Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-check"></i> Completed Tasks <span class="badge bg-secondary">{{ task_count }}</span></h2>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-list"></i> All Tasks
                </a>
            </div>
        </div>

        {% if tasks %}
        <div class="table-responsive">
            <table id="completedTable" class="table table-striped table-hover mobile-friendly">
                <thead class="table-dark">
                    <tr>
                        <th data-sort="text" role="button">Task Name <span class="sort-indicator"></span></th>
                        <th data-sort="text" role="button">Class <span class="sort-indicator"></span></th>
                        <th data-sort="date" role="button">Start Date <span class="sort-indicator"></span></th>
                        <th data-sort="date" role="button">Due Date <span class="sort-indicator"></span></th>
                        <th data-sort="text" role="button">Status <span class="sort-indicator"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr class="status-{{ task.status.lower().replace(' ', '-') }}">
                        <td>
                            <strong>{{ task.name }}</strong>
                            {% if task.get('is_recurring_instance') %}
                                <span class="badge bg-info">Recurring</span>
                            {% endif %}
                        </td>
                        <td>{{ task.course }}</td>
                        <td data-iso="{{ task.start_iso }}">{{ task.start_formatted }}</td>
                        <td data-iso="{{ task.due_iso }}">{{ task.due_formatted }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if task.status == 'Completed' else 'info' }}">{{ task.status }}</span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('delete_task', task_id=task.id) }}" class="btn btn-sm btn-outline-danger"
                                   onclick="return confirm('Are you sure you want to delete this task?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-check-circle fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No completed tasks</h4>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    function parseCell(td, type) {
        if (type === 'date') {
            const iso = td.getAttribute('data-iso');
            return iso ? new Date(iso).getTime() : 0;
        }
        return (td.textContent || '').toLowerCase();
    }
    function clearIndicators(headers) {
        headers.forEach(h => {
            const span = h.querySelector('.sort-indicator');
            if (span) span.textContent = '';
            h.removeAttribute('data-direction');
        });
    }
    function sortTable(table, colIndex, type, direction) {
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const multiplier = direction === 'asc' ? 1 : -1;
        rows.sort((a, b) => {
            const aVal = parseCell(a.children[colIndex], type);
            const bVal = parseCell(b.children[colIndex], type);
            if (aVal < bVal) return -1 * multiplier;
            if (aVal > bVal) return 1 * multiplier;
            return 0;
        });
        rows.forEach(r => tbody.appendChild(r));
    }
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('completedTable');
        if (!table) return;
        const headers = Array.from(table.tHead.querySelectorAll('th'));
        headers.forEach((th, idx) => {
            const type = th.getAttribute('data-sort');
            if (!type) return;
            th.addEventListener('click', function() {
                const current = th.getAttribute('data-direction') || 'none';
                const next = current === 'asc' ? 'desc' : 'asc';
                clearIndicators(headers);
                th.setAttribute('data-direction', next);
                const indicator = th.querySelector('.sort-indicator');
                if (indicator) indicator.textContent = next === 'asc' ? '▲' : '▼';
                sortTable(table, idx, type, next);
            });
        });
        // Default sort by Due Date descending for completed
        const dueIdx = 3;
        const dueHeader = headers[dueIdx];
        if (dueHeader && dueHeader.getAttribute('data-sort') === 'date') {
            clearIndicators(headers);
            dueHeader.setAttribute('data-direction', 'desc');
            const indicator = dueHeader.querySelector('.sort-indicator');
            if (indicator) indicator.textContent = '▼';
            sortTable(table, dueIdx, 'date', 'desc');
        }
    });
})();
</script>
{% endblock %}
